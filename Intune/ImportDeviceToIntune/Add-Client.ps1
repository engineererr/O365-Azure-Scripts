# credit: http://rzander.azurewebsites.net/automatically-register-existing-device-in-autopilot/
# version from credits was old and didn't work for me anymore

# true = dummy values are used
# false = values from current devices are used
$testMode = $true

# true = local copy of automation runbook is used (for DEV purposes)
# false = web hook of automation runbook is called
$localMode = $false

# Azure Automation Webhook URI
$uri = ""

# Used to identify imports
$orderIdentifier = "MyOrder"

if($testMode){
    # dummy values but correct format
    $hwid = "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AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"
    $ser = "005331390557"
}else{
    # Get Hardware Hash
    $hwid = ((Get-WMIObject -Namespace root/cimv2/mdm/dmmap -Class MDM_DevDetail_Ext01 -Filter "InstanceID='Ext' AND ParentID='./DevDetail'").DeviceHardwareData)
    # Get SerialNumber
    $ser = (Get-WmiObject win32_bios).SerialNumber
    # Use Computername if SerialNumber is empty
    if([string]::IsNullOrWhiteSpace($ser)) { $ser = $env:computername}  
}
    
# Create object with the required parameters
$devdata  = @{ SerialNumber=$ser;HardwareHash=$hwid;OrderIdentifier=$orderIdentifier }
$body = ConvertTo-Json -InputObject $devdata 

if($localMode){
    # Invoke local script
    $command = "C:\projects\auto-pilot-registration\RunBook.ps1 -SerialNumber 'ha' -HardwareHash '$hwid' -OrderIdentifier '$ser' -local `$true"
    Invoke-Expression $command
}else{
    # Send request to Webhook
    $response = Invoke-RestMethod -Method Post -Uri $uri -Body $body
    $response.JobIds
}
